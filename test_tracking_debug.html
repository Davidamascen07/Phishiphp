<!DOCTYPE html>
<html>
<head>
    <title>Teste de Tracking de Email - Debug</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; } .error { color: red; } .info { color: blue; }
        .tracking-img { border: 2px solid red; width: 50px; height: 50px; }
    </style>
</head>
<body>
    <h1>üî¨ Debug do Sistema de Tracking de Email</h1>
    
    <div class="section">
        <h2>1. Informa√ß√µes da Campanha</h2>
        <div id="campaign-info"></div>
    </div>
    
    <div class="section">
        <h2>2. Teste de URL de Tracking</h2>
        <p>Vamos testar diferentes URLs de tracking:</p>
        <div id="tracking-tests"></div>
    </div>
    
    <div class="section">
        <h2>3. Teste de Imagem de Tracking (Simula√ß√£o do Email)</h2>
        <p>Esta imagem simula o que aparece no email:</p>
        <div id="email-simulation"></div>
    </div>
    
    <div class="section">
        <h2>4. Verifica√ß√£o de Logs</h2>
        <p>Verifique o arquivo de log do PHP para ver se o tracking est√° sendo registrado.</p>
        <div id="log-info"></div>
    </div>
    
    <script>
    $(document).ready(function() {
        loadCampaignInfo();
    });
    
    function loadCampaignInfo() {
        $.get('debug_email_tracking.php')
        .done(function(data) {
            // Extrair informa√ß√µes da resposta
            $('#campaign-info').html(data);
            
            // Tentar extrair campaign_id da resposta para teste
            extractCampaignData(data);
        })
        .fail(function() {
            $('#campaign-info').html('<div class="error">‚ùå Erro ao carregar informa√ß√µes da campanha</div>');
        });
    }
    
    function extractCampaignData(htmlData) {
        // Tentar extrair campaign_id da tabela HTML
        let campaignId = null;
        let rid = null;
        
        // Parse b√°sico para extrair dados da tabela
        if (htmlData.includes('<td>')) {
            let match = htmlData.match(/<td>([a-zA-Z0-9_]+)<\/td>/);
            if (match) {
                campaignId = match[1];
            }
        }
        
        if (campaignId) {
            // Buscar RID para esta campanha
            findRidForCampaign(campaignId);
        } else {
            $('#tracking-tests').html('<div class="error">‚ùå N√£o foi poss√≠vel encontrar campaign_id</div>');
        }
    }
    
    function findRidForCampaign(campaignId) {
        $.ajax({
            url: 'spear/manager/mail_campaign_manager.php',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action_type: "multi_get_mcampinfo_from_mcamp_list_id_get_live_mcamp_data",
                campaign_id: campaignId,
                start: 0,
                length: 1,
                search: {value: ""},
                order: [{column: 0, dir: "asc"}],
                columns: [{data: "rid"}],
                selected_col: ["rid", "user_email"],
                tb_data_single: true
            }),
            success: function(response) {
                console.log('Response:', response);
                if (response.data && response.data.length > 0) {
                    let rid = response.data[0].rid;
                    let userEmail = response.data[0].user_email || 'unknown';
                    
                    testTrackingUrls(campaignId, rid, userEmail);
                } else {
                    $('#tracking-tests').html('<div class="error">‚ùå Nenhum RID encontrado para campanha ' + campaignId + '</div>');
                }
            },
            error: function(xhr) {
                $('#tracking-tests').html('<div class="error">‚ùå Erro ao buscar RID: ' + xhr.responseText + '</div>');
            }
        });
    }
    
    function testTrackingUrls(campaignId, rid, userEmail) {
        let baseUrl = window.location.origin + window.location.pathname.replace('/test_tracking_debug.html', '');
        
        let trackingUrls = [
            `${baseUrl}/tmail.php?rid=${rid}&mid=${campaignId}&mtid=teste29`,
            `${baseUrl}/tmail.php?rid=${rid}&mid=${campaignId}&mtid=teste_123`,
            `${baseUrl}/tmail.php?rid=${rid}&mid=${campaignId}&mtid=default_456`
        ];
        
        let html = `
            <div class="info">
                <p><strong>Campaign ID:</strong> ${campaignId}</p>
                <p><strong>RID:</strong> ${rid}</p>
                <p><strong>Email:</strong> ${userEmail}</p>
                <h4>URLs de Teste:</h4>
            </div>
        `;
        
        trackingUrls.forEach(function(url, index) {
            html += `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                    <p><strong>Teste ${index + 1}:</strong></p>
                    <p><code>${url}</code></p>
                    <button onclick="testUrl('${url}', ${index + 1})">Testar URL ${index + 1}</button>
                    <a href="${url}" target="_blank">Abrir em Nova Aba</a>
                    <div id="result-${index + 1}"></div>
                </div>
            `;
        });
        
        $('#tracking-tests').html(html);
        
        // Simular imagem no email
        simulateEmailTracking(trackingUrls[0]);
    }
    
    function testUrl(url, testNumber) {
        let resultDiv = $(`#result-${testNumber}`);
        resultDiv.html('<div class="info">üîÑ Testando...</div>');
        
        // Criar imagem para testar carregamento
        let img = new Image();
        img.onload = function() {
            resultDiv.html('<div class="success">‚úÖ Imagem carregou com sucesso!</div>');
        };
        img.onerror = function() {
            resultDiv.html('<div class="error">‚ùå Erro ao carregar imagem</div>');
        };
        img.src = url + '&cache_bust=' + Date.now();
    }
    
    function simulateEmailTracking(trackingUrl) {
        let html = `
            <div style="border: 2px dashed #333; padding: 20px; background: #f9f9f9;">
                <h4>üìß Simula√ß√£o do Conte√∫do do Email:</h4>
                <p>Hi david,</p>
                <p>Thank you for your email. We will meet soon.</p>
                <p>Thanks & Regards<br>Rose</p>
                <p><strong>Imagem de Tracking (invis√≠vel no email real):</strong></p>
                <img src="${trackingUrl}" alt="tracking" style="width: 1px; height: 1px; border: 1px solid red;" 
                     onload="$('#email-simulation').append('<div class=\\"success\\">‚úÖ Tracking funcionou!</div>')"
                     onerror="$('#email-simulation').append('<div class=\\"error\\">‚ùå Tracking falhou!</div>')">
                <p><em>Nota: A imagem acima deveria ser 1x1 pixel invis√≠vel, mas foi aumentada para visualiza√ß√£o</em></p>
            </div>
        `;
        
        $('#email-simulation').html(html);
    }
    </script>
</body>
</html>