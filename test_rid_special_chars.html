<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Teste RID com Caracteres Especiais</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-box {
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            color: white;
        }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: black; }
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🧪 Teste RID com Caracteres Especiais</h1>
    
    <div class="test-box">
        <h3>🎯 TESTE DA CORREÇÃO DO PROBLEMA RID</h3>
        <p><strong>Problema identificado:</strong> A função doFilter() estava removendo underscores, hífens e outros caracteres do RID.</p>
        <p><strong>Correção aplicada:</strong> Usar regex mais permissiva que permite a-z, A-Z, 0-9, _, -, .</p>
    </div>

    <div class="test-box">
        <h3>🔗 Testes com Diferentes Tipos de RID</h3>
        <p>Clique nos links abaixo para testar RIDs com diferentes caracteres:</p>
        
        <a href="?rid=simple123" class="btn btn-primary">📝 Simple123</a>
        <a href="?rid=email_campaign_001" class="btn btn-primary">📧 email_campaign_001</a>
        <a href="?rid=social-media-456" class="btn btn-primary">🌐 social-media-456</a>
        <a href="?rid=test.tracker.789" class="btn btn-primary">🔗 test.tracker.789</a>
        <a href="?rid=mix_all-types.123" class="btn btn-success">🎯 mix_all-types.123</a>
        <a href="?rid=underscores___only" class="btn btn-warning">➖ underscores___only</a>
        <a href="?rid=---hyphens-only---" class="btn btn-warning">➖ ---hyphens-only---</a>
    </div>

    <div class="test-box">
        <h3>📊 RID Atual</h3>
        <div class="code" id="current-rid">Carregando...</div>
    </div>

    <div class="test-box">
        <h3>🧪 Teste Manual Imediato</h3>
        <p>Este botão enviará dados para o servidor usando o RID da URL atual:</p>
        <button onclick="testCurrentRid()" class="btn btn-success">🚀 Testar RID Atual</button>
        <div id="test-result" class="code" style="margin-top: 15px;">Resultado aparecerá aqui...</div>
    </div>

    <div class="test-box">
        <h3>📋 Verificar Dados Salvos</h3>
        <p>Após fazer os testes, verifique se os RIDs foram salvos corretamente:</p>
        <a href="https://loophish.local/spear/TrackerReport?tracker=daxn8c" target="_blank" class="btn btn-primary">📊 Ver Relatório</a>
        <a href="https://loophish.local/verify_rid_database.php" target="_blank" class="btn btn-warning">🔍 Ver Debug Banco</a>
    </div>

    <script>
        // Mostrar RID atual
        const urlParams = new URLSearchParams(window.location.search);
        const currentRid = urlParams.get('rid');
        
        document.getElementById('current-rid').textContent = `
URL: ${window.location.href}
RID da URL: ${currentRid || '(não encontrado)'}
RID escapado: ${currentRid ? encodeURIComponent(currentRid) : '(n/a)'}
Caracteres no RID: ${currentRid ? currentRid.split('').join(', ') : '(n/a)'}
        `;

        function testCurrentRid() {
            const rid = urlParams.get('rid') || '';
            
            const testData = {
                page: 0,
                trackerId: 'daxn8c',
                sess_id: 'rid_test_' + Date.now(),
                screen_res: screen.width + "x" + screen.height,
                rid: rid,
                ip_info: null
            };

            document.getElementById('test-result').textContent = `ENVIANDO DADOS:
RID Original: "${rid}"
Dados completos: ${JSON.stringify(testData, null, 2)}

Aguardando resposta do servidor...`;

            fetch('https://loophish.local/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('test-result').textContent = `RESULTADO DO TESTE:

✅ RESPOSTA DO SERVIDOR: "${data}"

📊 DADOS ENVIADOS:
   RID Original: "${rid}"
   RID Length: ${rid.length}
   Tracker ID: daxn8c
   Session: ${testData.sess_id}

🔍 PRÓXIMOS PASSOS:
1. Verifique o relatório para ver se o RID aparece corretamente
2. Se ainda estiver vazio, o problema pode estar em outro lugar
3. Use o link "Ver Debug Banco" para verificar dados salvos`;

                // Destacar sucesso se recebeu "success"
                if (data.trim() === 'success') {
                    document.getElementById('test-result').style.background = '#d4edda';
                    document.getElementById('test-result').style.borderColor = '#28a745';
                } else {
                    document.getElementById('test-result').style.background = '#f8d7da';
                    document.getElementById('test-result').style.borderColor = '#dc3545';
                }
            })
            .catch(error => {
                document.getElementById('test-result').textContent = `❌ ERRO:
${error}

Verifique se o servidor está funcionando corretamente.`;
                document.getElementById('test-result').style.background = '#f8d7da';
            });
        }

        // Log do RID no console
        console.log('RID atual:', currentRid);
        console.log('Caracteres do RID:', currentRid ? currentRid.split('') : 'N/A');
    </script>
</body>
</html>