<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç DEBUG ESPEC√çFICO - Teste RID</title>
    <script src="https://loophish.local/mod?tlink=daxn8c" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .debug-box {
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            color: white;
        }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: black; }
        
        #live-log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç DEBUG ESPEC√çFICO - Problema com RID</h1>
    
    <div class="debug-box">
        <h3>üìä Informa√ß√µes da URL Atual</h3>
        <div class="code" id="url-info">Carregando...</div>
    </div>

    <div class="debug-box">
        <h3>üîß Status das Vari√°veis do Tracker</h3>
        <div class="code" id="tracker-vars">Aguardando carregamento do tracker...</div>
    </div>

    <div class="debug-box">
        <h3>üß™ Testes de RID</h3>
        <p>Use estes links para testar diferentes cen√°rios de RID:</p>
        <a href="?rid=teste_simples" class="btn btn-primary">üìÑ RID Simples</a>
        <a href="?rid=email_campaign_123" class="btn btn-primary">üìß RID Email</a>
        <a href="?rid=social_media_456" class="btn btn-primary">üåê RID Social</a>
        <a href="?rid=sms_789" class="btn btn-primary">üì± RID SMS</a>
        <a href="?" class="btn btn-danger">‚ùå Sem RID</a>
        <button onclick="testManualRid()" class="btn btn-warning">üîß Teste Manual</button>
    </div>

    <div class="debug-box">
        <h3>üì° Teste de Envio For√ßado</h3>
        <p>Force o envio de dados para o servidor e veja a resposta:</p>
        <button onclick="forcePageVisit()" class="btn btn-success">üìÑ For√ßar Page Visit</button>
        <button onclick="forceFormSubmit()" class="btn btn-success">üìù For√ßar Form Submit</button>
        <div id="send-result" class="code" style="min-height: 100px;">Resultados dos testes aparecer√£o aqui...</div>
    </div>

    <div class="debug-box">
        <h3>üìù Log em Tempo Real</h3>
        <div id="live-log">Aguardando atividade...<br></div>
        <button onclick="clearLog()" class="btn btn-warning">üßπ Limpar</button>
    </div>

    <script>
        let logContainer = document.getElementById('live-log');
        let urlInfoContainer = document.getElementById('url-info');
        let trackerVarsContainer = document.getElementById('tracker-vars');
        let sendResultContainer = document.getElementById('send-result');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#007bff',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            logContainer.innerHTML += `<span style="color: ${colors[type]};">[${timestamp}] ${message}</span><br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[RID DEBUG] ${message}`);
        }

        function clearLog() {
            logContainer.innerHTML = 'Log limpo.<br>';
        }

        function updateUrlInfo() {
            const url = window.location.href;
            const search = window.location.search;
            const urlParams = new URLSearchParams(search);
            const ridFromUrl = urlParams.get('rid');
            
            urlInfoContainer.textContent = `
URL Completa: ${url}
Search String: ${search || '(vazio)'}
RID da URL (URLSearchParams): ${ridFromUrl || '(n√£o encontrado)'}
RID da URL (regex): ${search.match(/[?&]rid=([^&]+)/) ? search.match(/[?&]rid=([^&]+)/)[1] : '(n√£o encontrado)'}
Todos os Par√¢metros: ${Array.from(urlParams.entries()).map(([k,v]) => `${k}=${v}`).join(', ') || '(nenhum)'}
            `;
        }

        function updateTrackerVars() {
            try {
                const info = {
                    'rid (tracker)': typeof rid !== 'undefined' ? `"${rid}"` : 'UNDEFINED',
                    'tracker_id': typeof tracker_id !== 'undefined' ? `"${tracker_id}"` : 'UNDEFINED',
                    'sess_id': typeof sess_id !== 'undefined' ? `"${sess_id}"` : 'UNDEFINED',
                    'ip_info': typeof ip_info !== 'undefined' ? 'Carregado' : 'UNDEFINED',
                    'form_field_data': typeof form_field_data !== 'undefined' ? JSON.stringify(form_field_data) : 'UNDEFINED'
                };
                
                let output = '';
                for (const [key, value] of Object.entries(info)) {
                    output += `${key}: ${value}\n`;
                }
                
                trackerVarsContainer.textContent = output;
                
                // Log se RID est√° definido
                if (typeof rid !== 'undefined') {
                    log(`‚úÖ RID carregado: "${rid}"`, 'success');
                } else {
                    log(`‚ùå RID n√£o definido ainda`, 'error');
                }
                
            } catch (e) {
                trackerVarsContainer.textContent = `ERRO: ${e.message}`;
                log(`‚ùå Erro ao verificar vari√°veis: ${e.message}`, 'error');
            }
        }

        // Interceptar XMLHttpRequest
        const originalSend = XMLHttpRequest.prototype.send;
        const originalOpen = XMLHttpRequest.prototype.open;
        
        XMLHttpRequest.prototype.open = function(method, url, async) {
            this._method = method;
            this._url = url;
            this._startTime = Date.now();
            return originalOpen.call(this, method, url, async);
        };

        XMLHttpRequest.prototype.send = function(data) {
            const self = this;
            
            if (this._url && this._url.includes('/track')) {
                log(`üì° ENVIANDO REQUEST para /track`, 'warning');
                log(`   M√©todo: ${this._method}`, 'info');
                
                try {
                    const parsedData = JSON.parse(data);
                    log(`   üìä Dados enviados:`, 'info');
                    log(`      RID: "${parsedData.rid || '(vazio)'}"`, parsedData.rid ? 'success' : 'warning');
                    log(`      Tracker ID: "${parsedData.trackerId}"`, 'info');
                    log(`      Session ID: "${parsedData.sess_id}"`, 'info');
                    log(`      Page: ${parsedData.page}`, 'info');
                    log(`      Screen: ${parsedData.screen_res}`, 'info');
                    
                    // Mostrar dados completos
                    sendResultContainer.textContent = `DADOS ENVIADOS:\n${JSON.stringify(parsedData, null, 2)}`;
                    
                } catch (e) {
                    log(`   ‚ö†Ô∏è Dados n√£o JSON: ${data}`, 'warning');
                    sendResultContainer.textContent = `DADOS ENVIADOS (RAW):\n${data}`;
                }
            }
            
            // Interceptar resposta
            this.addEventListener('readystatechange', function() {
                if (this.readyState === 4 && self._url && self._url.includes('/track')) {
                    const duration = Date.now() - self._startTime;
                    if (this.status === 200) {
                        log(`‚úÖ RESPOSTA (${duration}ms): "${this.responseText}"`, 'success');
                        sendResultContainer.textContent += `\n\nRESPOSTA DO SERVIDOR:\nStatus: ${this.status}\nResponse: ${this.responseText}\nDura√ß√£o: ${duration}ms`;
                    } else {
                        log(`‚ùå ERRO HTTP ${this.status} (${duration}ms): ${this.responseText}`, 'error');
                        sendResultContainer.textContent += `\n\nERRO DO SERVIDOR:\nStatus: ${this.status}\nResponse: ${this.responseText}\nDura√ß√£o: ${duration}ms`;
                    }
                }
            });
            
            return originalSend.call(this, data);
        };

        function forcePageVisit() {
            log('üß™ FOR√áANDO PAGE VISIT...', 'warning');
            sendResultContainer.textContent = 'Enviando page visit...';
            
            if (typeof do_track_req_visit === 'function') {
                do_track_req_visit();
            } else {
                // Envio manual
                const data = {
                    page: 0,
                    trackerId: typeof tracker_id !== 'undefined' ? tracker_id : 'daxn8c',
                    sess_id: typeof sess_id !== 'undefined' ? sess_id : 'manual_' + Date.now(),
                    screen_res: screen.width + "x" + screen.height,
                    rid: typeof rid !== 'undefined' ? rid : new URLSearchParams(window.location.search).get('rid') || '',
                    ip_info: typeof ip_info !== 'undefined' ? ip_info : null
                };
                
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "https://loophish.local/track", true);
                xhr.send(JSON.stringify(data));
            }
        }

        function forceFormSubmit() {
            log('üß™ FOR√áANDO FORM SUBMIT...', 'warning');
            sendResultContainer.textContent = 'Enviando form submit...';
            
            const formData = {
                email: 'teste@debug.com',
                senha: 'debug123'
            };
            
            const data = {
                page: 1,
                trackerId: typeof tracker_id !== 'undefined' ? tracker_id : 'daxn8c',
                sess_id: typeof sess_id !== 'undefined' ? sess_id : 'manual_' + Date.now(),
                screen_res: screen.width + "x" + screen.height,
                form_field_data: formData,
                rid: typeof rid !== 'undefined' ? rid : new URLSearchParams(window.location.search).get('rid') || '',
                ip_info: typeof ip_info !== 'undefined' ? ip_info : null
            };
            
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "https://loophish.local/track", true);
            xhr.send(JSON.stringify(data));
        }

        function testManualRid() {
            const testRid = prompt('Digite um RID para teste:', 'manual_test_' + Date.now());
            if (testRid) {
                window.location.href = window.location.href.split('?')[0] + '?rid=' + encodeURIComponent(testRid);
            }
        }

        // Inicializa√ß√£o
        log('üöÄ P√°gina carregada, iniciando debug...', 'info');
        updateUrlInfo();
        
        // Atualizar informa√ß√µes periodicamente
        const updateInterval = setInterval(() => {
            updateTrackerVars();
        }, 1000);
        
        // Parar depois de 30 segundos
        setTimeout(() => {
            clearInterval(updateInterval);
            log('‚è±Ô∏è Debug autom√°tico finalizado ap√≥s 30s', 'info');
        }, 30000);

        // Log inicial da URL
        log(`üìç URL: ${window.location.href}`, 'info');
        log(`üîó RID da URL: ${new URLSearchParams(window.location.search).get('rid') || '(n√£o encontrado)'}`, 'info');
    </script>
</body>
</html>