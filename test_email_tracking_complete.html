<!DOCTYPE html>
<html>
<head>
    <title>Teste Completo de Email Tracking</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; } .error { color: red; } .info { color: blue; }
    </style>
</head>
<body>
    <h1>üîç Teste Completo de Email Tracking</h1>
    
    <div class="test-section">
        <h2>1. Verificar Estrutura do Banco</h2>
        <button onclick="checkDatabase()">Verificar Banco de Dados</button>
        <div id="db-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Testar Tracking de Email</h2>
        <p>Primeiro, escolha uma campanha ativa:</p>
        <select id="campaign-select"></select>
        <button onclick="loadCampaigns()">Carregar Campanhas</button><br><br>
        <button onclick="testEmailTracking()">Simular Abertura de Email</button>
        <div id="tracking-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Verificar Dashboard Data</h2>
        <button onclick="checkDashboardData()">Verificar Dados do Dashboard</button>
        <div id="dashboard-result"></div>
    </div>
    
    <script>
    function checkDatabase() {
        $.get('debug_email_tracking.php')
        .done(function(data) {
            $('#db-result').html('<div class="success">‚úÖ ' + data + '</div>');
        })
        .fail(function() {
            $('#db-result').html('<div class="error">‚ùå Erro ao verificar banco</div>');
        });
    }
    
    function loadCampaigns() {
        $.ajax({
            url: 'spear/manager/mail_campaign_manager.php',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action_type: "get_campaign_list_from_active_user"
            }),
            success: function(response) {
                console.log('Campanhas:', response);
                let select = $('#campaign-select');
                select.empty();
                if (response.data && response.data.length > 0) {
                    response.data.forEach(function(campaign) {
                        select.append(`<option value="${campaign.campaign_id}">${campaign.camp_name} (Status: ${campaign.camp_status})</option>`);
                    });
                } else {
                    select.append('<option>Nenhuma campanha encontrada</option>');
                }
            },
            error: function(xhr) {
                console.error('Erro ao carregar campanhas:', xhr.responseText);
            }
        });
    }
    
    function testEmailTracking() {
        let campaignId = $('#campaign-select').val();
        if (!campaignId) {
            alert('Selecione uma campanha primeiro');
            return;
        }
        
        // Primeiro, vamos buscar um RID v√°lido para esta campanha
        $.ajax({
            url: 'spear/manager/mail_campaign_manager.php',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action_type: "multi_get_mcampinfo_from_mcamp_list_id_get_live_mcamp_data",
                campaign_id: campaignId,
                start: 0,
                length: 1,
                search: {value: ""},
                order: [{column: 0, dir: "asc"}],
                columns: [{data: "rid"}],
                selected_col: ["rid"],
                tb_data_single: true
            }),
            success: function(response) {
                if (response.data && response.data.length > 0) {
                    let rid = response.data[0].rid;
                    let trackingUrl = `tmail.php?rid=${rid}&mid=${campaignId}&mtid=teste29`;
                    
                    $('#tracking-result').html(`
                        <div class="info">
                            <p>Testando tracking para:</p>
                            <p><strong>Campaign ID:</strong> ${campaignId}</p>
                            <p><strong>RID:</strong> ${rid}</p>
                            <p><strong>URL:</strong> <a href="${trackingUrl}" target="_blank">${trackingUrl}</a></p>
                        </div>
                    `);
                    
                    // Simular clique no tracking
                    $('<img>').attr('src', trackingUrl).on('load error', function() {
                        $('#tracking-result').append('<div class="success">‚úÖ Tracking executado! Verifique os logs.</div>');
                    });
                } else {
                    $('#tracking-result').html('<div class="error">‚ùå Nenhum RID encontrado para esta campanha</div>');
                }
            },
            error: function(xhr) {
                $('#tracking-result').html('<div class="error">‚ùå Erro: ' + xhr.responseText + '</div>');
            }
        });
    }
    
    function checkDashboardData() {
        let campaignId = $('#campaign-select').val();
        if (!campaignId) {
            alert('Selecione uma campanha primeiro');
            return;
        }
        
        $.ajax({
            url: 'spear/manager/mail_campaign_manager.php',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action_type: "get_campaign_from_campaign_list_id",
                campaign_id: campaignId
            }),
            success: function(response) {
                console.log('Dashboard data:', response);
                $('#dashboard-result').html(`
                    <div class="info">
                        <h4>Dados da Campanha:</h4>
                        <p><strong>Email Sent:</strong> ${response.live_mcamp_data?.sent_success_count || 0}</p>
                        <p><strong>Email Opened:</strong> ${response.live_mcamp_data?.mail_open_count || 0}</p>
                        <p><strong>Status:</strong> ${response.campaign_data?.camp_status || 'N/A'}</p>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    </div>
                `);
            },
            error: function(xhr) {
                $('#dashboard-result').html('<div class="error">‚ùå Erro: ' + xhr.responseText + '</div>');
            }
        });
    }
    
    // Auto-carregar campanhas ao abrir a p√°gina
    $(document).ready(function() {
        loadCampaigns();
    });
    </script>
</body>
</html>